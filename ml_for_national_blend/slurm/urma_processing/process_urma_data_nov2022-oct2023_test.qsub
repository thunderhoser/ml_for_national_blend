#!/bin/tcsh

#SBATCH --job-name="process_urma_data_nov2022-oct2023_test"
#SBATCH --partition="fge"
#SBATCH --account="rda-ghpcs"
#SBATCH --qos="gpu"
#SBATCH --ntasks=1
#SBATCH --nodes=1
#SBATCH --cpus-per-task=1
##SBATCH --nodes=1
##SBATCH --ntasks=1
##SBATCH --cpus-per-task=1
##SBATCH --ntasks-per-node=1
#SBATCH --time=02:00:00
#SBATCH --array=1
#SBATCH --exclude=h28n12
##SBATCH --exclude=h31n03,h28n12
##SBATCH --exclude=h29n01,h26n05,h28n06,h29n07,h30n03,h30n15
#SBATCH --mail-type=BEGIN,END,FAIL
#SBATCH --mail-user=ryan.lagerquist@noaa.gov
#SBATCH --output=process_urma_data_nov2022-oct2023_test_%A_%a.out

module load cuda/10.1
module load gnu/9.2.0
module load wgrib2/3.1.1_ncep

source /scratch2/BMC/gsd-hpcs/Jebb.Q.Stewart/conda3.7/etc/profile.d/conda.csh
conda activate base

set CODE_DIR_NAME="/scratch1/RDARCH/rda-ghpcs/Ryan.Lagerquist/ml_for_national_blend_standalone/ml_for_national_blend"
set INPUT_DIR_NAME="/scratch2/STI/mdl-sti/Allison.Layne/firewx_test_data/urma/grib2"
set OUTPUT_DIR_NAME="/scratch1/RDARCH/rda-ghpcs/Ryan.Lagerquist/ml_for_national_blend_project/urma_data/processed"
set WGRIB2_EXE_NAME="wgrib2"

set VALID_DATE_STRINGS=("20221101" "20221102" "20221103" "20221104" "20221105" "20221106" "20221107" "20221108" "20221109" "20221110" "20221111" "20221112" "20221113" "20221114" "20221115" "20221116" "20221117" "20221118" "20221119" "20221120" "20221121" "20221122" "20221123" "20221124" "20221125" "20221126" "20221127" "20221128" "20221129" "20221130" "20221201" "20221202" "20221203" "20221204" "20221205" "20221206" "20221207" "20221208" "20221209" "20221210" "20221211" "20221212" "20221213" "20221214" "20221215" "20221216" "20221217" "20221218" "20221219" "20221220" "20221221" "20221222" "20221223" "20221224" "20221225" "20221226" "20221227" "20221228" "20221229" "20221230" "20221231" "20230101" "20230102" "20230103" "20230104" "20230105" "20230106" "20230107" "20230108" "20230109" "20230110" "20230111" "20230112" "20230113" "20230114" "20230115" "20230116" "20230117" "20230118" "20230119" "20230120" "20230121" "20230122" "20230123" "20230124" "20230125" "20230126" "20230127" "20230128" "20230129" "20230130" "20230131" "20230201" "20230202" "20230203" "20230204" "20230205" "20230206" "20230207" "20230208" "20230209" "20230210" "20230211" "20230212" "20230213" "20230214" "20230215" "20230216" "20230217" "20230218" "20230219" "20230220" "20230221" "20230222" "20230223" "20230224" "20230225" "20230226" "20230227" "20230228" "20230301" "20230302" "20230303" "20230304" "20230305" "20230306" "20230307" "20230308" "20230309" "20230310" "20230311" "20230312" "20230313" "20230314" "20230315" "20230316" "20230317" "20230318" "20230319" "20230320" "20230321" "20230322" "20230323" "20230324" "20230325" "20230326" "20230327" "20230328" "20230329" "20230330" "20230331" "20230401" "20230402" "20230403" "20230404" "20230405" "20230406" "20230407" "20230408" "20230409" "20230410" "20230411" "20230412" "20230413" "20230414" "20230415" "20230416" "20230417" "20230418" "20230419" "20230420" "20230421" "20230422" "20230423" "20230424" "20230425" "20230426" "20230427" "20230428" "20230429" "20230430" "20230501" "20230502" "20230503" "20230504" "20230505" "20230506" "20230507" "20230508" "20230509" "20230510" "20230511" "20230512" "20230513" "20230514" "20230515" "20230516" "20230517" "20230518" "20230519" "20230520" "20230521" "20230522" "20230523" "20230524" "20230525" "20230526" "20230527" "20230528" "20230529" "20230530" "20230531" "20230601" "20230602" "20230603" "20230604" "20230605" "20230606" "20230607" "20230608" "20230609" "20230610" "20230611" "20230612" "20230613" "20230614" "20230615" "20230616" "20230617" "20230618" "20230619" "20230620" "20230621" "20230622" "20230623" "20230624" "20230625" "20230626" "20230627" "20230628" "20230629" "20230630" "20230701" "20230702" "20230703" "20230704" "20230705" "20230706" "20230707" "20230708" "20230709" "20230710" "20230711" "20230712" "20230713" "20230714" "20230715" "20230716" "20230717" "20230718" "20230719" "20230720" "20230721" "20230722" "20230723" "20230724" "20230725" "20230726" "20230727" "20230728" "20230729" "20230730" "20230731" "20230801" "20230802" "20230803" "20230804" "20230805" "20230806" "20230807" "20230808" "20230809" "20230810" "20230811" "20230812" "20230813" "20230814" "20230815" "20230816" "20230817" "20230818" "20230819" "20230820" "20230821" "20230822" "20230823" "20230824" "20230825" "20230826" "20230827" "20230828" "20230829" "20230830" "20230831" "20230901" "20230902" "20230903" "20230904" "20230905" "20230906" "20230907" "20230908" "20230909" "20230910" "20230911" "20230912" "20230913" "20230914" "20230915" "20230916" "20230917" "20230918" "20230919" "20230920" "20230921" "20230922" "20230923" "20230924" "20230925" "20230926" "20230927" "20230928" "20230929" "20230930" "20231001" "20231002" "20231003" "20231004" "20231005" "20231006" "20231007" "20231008" "20231009" "20231010" "20231011" "20231012" "20231013" "20231014" "20231015" "20231016" "20231017" "20231018" "20231019" "20231020" "20231021" "20231022" "20231023" "20231024" "20231025" "20231026" "20231027" "20231028" "20231029" "20231030" "20231031")
set i=$SLURM_ARRAY_TASK_ID

while ($i <= `expr $SLURM_ARRAY_TASK_ID + 0` && $i <= $#VALID_DATE_STRINGS)
    set valid_date_string="${VALID_DATE_STRINGS[$i]}"
    
    python3 -u "${CODE_DIR_NAME}/process_urma_data.py" \
    --input_grib2_dir_name="${INPUT_DIR_NAME}" \
    --first_valid_date_string="${valid_date_string}" \
    --last_valid_date_string="${valid_date_string}" \
    --wgrib2_exe_file_name="${WGRIB2_EXE_NAME}" \
    --temporary_dir_name="${OUTPUT_DIR_NAME}/tmp/${valid_date_string}" \
    --output_netcdf_dir_name="${OUTPUT_DIR_NAME}"
    
    @ i = $i + 1
end
